---
title: "Redis Sentinel Cluster"
date: 2022-01-10T01:11:11+08:00
draft: true
toc: true
images:
tags: 
  - redis
---

主从模式下的高可用，通过哨兵机制来保证，哨兵机制可以实现主从库的自动切换，解决主从复制模式下的故障转移，主要任务是 **监控、选主、通知**。

哨兵是一个运行在特殊模式下的一个 Redis 进程，可以看作一个 sidercar。

## 监控

哨兵进程运行时，周期性的给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。

如果没有在周期规定时间内响应哨兵的 PING 命令，哨兵就会标记为 **下线状态**，主节点没有正常响应，就会开始切换主库的流程。

### 主观下线

哨兵发现主库响应超时，哨兵会对它标记为 "主观下线"，集中式架构下的主节点不能轻易的变换。如果发现从库下线就直接下线，从库的下线一半影响不大，集群对外的服务不会间断。

如果哨兵误判主节点下线，后续的选主和通知的开销都是没必要的，误判一般发生在集群网络压力较大、网络拥塞，或者主库本身压力较大的情况下。

多个哨兵实例一起来判断，避免单个实例由于一些特殊原因误判主节点下线，来提供容错，降低风险。

### 客观下线

存在 N 个哨兵时，有 N/2 + 1个实例判断主库主观下线，采用少数服从多数的原则，来认定主节点 “客观下线”，开始选主。

## 选主

判定主节点确实下线了之后，就从从库中选出来一个从库实例作为主库。

从节点选主通过对从节点筛选和打分的规则，来选出一个从库作为主库。

- 筛选

- 检查从库的当前在线状态，还要判断之前的网络链接状态，断连次数超过一定的阈值，就认定该从库网络状态不好，过滤掉，可以认为不足以作为主节点 （candidate）。

  down-after-milliseconds 认定主从库断连的最大连接超时时间，断连超过10次，就说明这个从库网络状况不好，不适合作为 主节点（candidate）。

- 三轮打分（从库优先级、从库复制进度、从库 ID 号）

  1. slave-priority 可根据从库的实际情况（规格、数据量、压力）来设置优先级，优先级最高的从库得分高。
  2. 和旧库同步程度最接近的从库得分高，保证新主库的数据最新。slave_repl_offset 最接近 master_repl_offset，从库同步进度一样，就需要第三轮打分。
  3. ID号小的从库得分高（优先级和复制进度都相同的情况下），表明该从节点连接较早且稳定。

## 通知

主节点切换后，哨兵需要把新主库的链接信息发送给其他从库，让它们执行 replicaof 命令，和新主库建立链接，并进行数据复制，同时哨兵会把新主库的链接信息通知给客户端，让它们把请求操作发送到新主库上。

## 选主过程中的写入

在选主过程中，**新的写入会失败**，**业务端无感知需要先将失败的请求缓存或写入MQ，等选完主后，在将这些操作写入**，主从切换时间过长，会导致客户端或MQ 写入请求过多，切换完重放请求时间过长。

down-after-milliseconds 可以让哨兵对主从切换敏感，切换及时对业务影响最小，但是可能会因为网络的抖动导致不必要的切换。配置的时间太长，可以减少哨兵误判的概率，但是在真正发生故障时，业务的写失败会比较久，缓存写入 请求数据量越多。



## pub/sub 哨兵集群

哨兵实例之间的互相发现通过 pub/sub 机制实现，哨兵和主库建立了连接，就可以在主库上发布消息，同时也可以从主库上订阅消息，获得其他哨兵的连接信息，多个哨兵都在主库上做了发布订阅操作后，哨兵实例之间就能够知道彼此之间的 IP 地址和端口。

主从集群中的主库 <__sentinel__:hello> 频道，哨兵通过它来通信实现互相发现，然后建立网络连接，哨兵通过**向主库发送 INFO 命令获取从库列表**，哨兵在和每个从库建立连接，并在建立的连接上持续地对从库进行监控。



## 客户端通知

主从切换后，客户端需要知道新的主库信息，**redis 通过事件让客户端知道哨兵工作过程中节点之间的变更事件**，哨兵实例也提供 pub/sub 机制，客户端可以从哨兵订阅消息，消息订阅频道对应不同切换过程中的不同关键事件。

## 切换关键事件

- 主库下线事件
  - +sdown  实例进入 主观下线
  - -sdown   实例退出 主观下线
  - +odown  实例进入 客观下线
  - -odown   实例退出 客观下线
- 从库重新配置事件
  - +slave-reconf-sent      哨兵发送 slaveof 命令冲洗配置从库
  - +slave-reconf-inprog  从库配置了新主库，但尚未进行同步
  - +slave-reconf-done     从库配置了新主库，并且和新主库完成同步
- 新主库切换
  - +switch-master 主库地址发生变化

## 由哪一个哨兵执行切换

任何一个实例判断出主库 “客观下线“ 后，就会给其他实例发送 ‘**is-master-down-by-addr**' 命令，其他实例会根据自己和主库的连接情况，作出 Y/N 响应。

quorum 可以配置获得投票数，也就是能够判定主库 "客观下线"的实例个数**。？如果增加实例个数，这个配置怎么更新？**

投票过程中，**想要成为 leader 的哨兵实例需要获得到半数以上的投票 并且 获得票数要大于等于哨兵配置文件中的 quorum 值**。

获得的票数没有满足条件，将继续进行投票，**如果哨兵集群只有两个实例，要想成为 leader 必须获得 2 票**。

哨兵对主库在线检测状态属于时间事件，使用定时器来完成，每个哨兵的定时器会在执行周期上加上一个小小的随机时间偏移，来错开多实例同时检测到主节点下线的时间，减少投票轮数，无法选出 leader，会等待 failover_timeout * 2 时间，进行下一轮投票。

一轮只投一票，这很 raft。

## 总结

- 基于 pub/sub 机制的组成哨兵集群

- 基于 INFO 命令的从库列表，帮助哨兵和从库建立连接

- 基于哨兵自身的 pub/sub 功能，实现了客户端和哨兵之间的事件通知

**要保证所有哨兵实例的配置是一致的，尤其是主观下线的判断 down-after-milliseconds**。

## Q

**？如果增加哨兵实例个数，这个配置怎么更新？**

## 切片集群


---
title: "Idempotent Cashier Hints"
date: 2022-01-21T14:11:18+08:00
draft: true
toc: true
images:
tags: 
  - engineering
---

## idempotent

最近在做支付平台，其实就我一个人。。。。。。

其实不算事支付平台，算是收银台，支付是用的第三方（银行）的支付工具。

收银台在没有支付（支付中）是可以重复拉起的，这一块不需要保证幂等，需要判断是重新进入收银台还是新的订单（大部分情况是重新进入收银台）。

## 99 -> 98 ->97

在一个就是如果流程中引入 redis，系统的整体可靠性就会有损（0.99 * 0.99 = 0.9801），redis 的可用性风险如果在引入 mq （不可用时数据临时转移到 mq,后面再重放），这种适合缓存业务，实时性比较高的数据临时数据写不到 redis (作为数据存储)，只能牺牲性能查询 MySQL，MySQL（m-s）又会有延迟。。。，同时代码要有不可靠的中间件降级逻辑。

## job-race

定时任务的间隔和争抢，这一块不太明白，现在用的是 elastic-job，它又依赖了 C_P 的 zk，需要注意定时任务的争抢导致请求的重复（分片？），这一块目前没有定时任务去发请求的，只设计状态的更新，通过数据库的版本号可以规避风险，由于涉及到很多回调通知，定时任务可能会比较密集，之前看 github 有一个 powerjob （无锁化），还没看。。。

## middleware

中间件的重复，nginx upstream 可以配置重试，还有其他负载均衡中间件我也不知道。。。。。。，另外要关注 dubbo，apigateway，feign，restTemplate 的重试. 

算是一个网关系统，后面可能会有审计统计功能，MySQL 表设计也要合理一些（还是我）

------



## todo

一些 安全(基于 appId 混合加密)，限流，降级，故障转移的暂时没想到问题（书看得少，没看到），后续再更新，先记录一下，问题慢慢解决。

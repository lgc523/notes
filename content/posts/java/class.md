---
title: "Class"
date: 2021-12-12T10:21:27+08:00
draft: true
toc: true
images:
tags: 
  - java
---

Jvm 的跨平台可以让一份 Class 文件运行在不通的平台上，Class 作为异构语言和 JVM 之间的重要桥梁，可以由源代码被编译成 Class 文件，并最终在 JVM 上执行，Clojure、Groovy、Scala、Jython等语言都可以活跃在 JVM 平台上。

## Class File

- 类的属性
- 类的方法
  - 访问标记
  - 名称
  - 描述符
  - 属性
    - 行号属性
    - 局部变量表
    - 栈映射帧
- 类的字段
  - 访问标记
  - 名称
  - 描述符
  - 属性
- 实现的接口
- 父类
- magic number  Class 文件的特征
- 小版本号
- 大版本号
- 常量池
  - 各种常量
  - 整数
  - 字符串
  - Class
- 访问标记
  - public
  - static
- 当前类

虚拟机规范中，Class 文件使用一种类似于 C 语言结构体的方式描述，统一使用无符号整数作为基本数据类型，u1、u2、u3、u4、u8 分别表示无符号的单字节、2字节、4字节、8字节整数，字符串用 u1 数组表示。

```
ClassFile{
	u4 magic;
	u2 minor_version;
	u2 major_version;
	u2 constant_pool_count;
	cp_info constant_pool[constant_pool_count-1];
	u2 access_flags;
	u2 this_class;
	u2 super_class;
	u2 interfaces_count;
	u2 interfaces[interfaces_count]
	u2 fields_count;
	field_info fields[fields_count]
	u2 methods_count;
	method_info methods[methods_count]
	u2 attributes_count;
	attribute_info attributes[attributes_count]
}
```

### Magic Number

魔数作为 Class 文件的标志，告诉虚拟机这个是 Class 文件，4字节无符号整数，固定为 0xCAFEBABE

```java
public class Simple {
    public static final int TYPE = 1;
    private int id;
    private String name;

    public void setId(int id) {
        try {
            this.id = id;
        } catch (IllegalStateException e) {
            System.out.println(e.toString());
        }
    }

    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }
}
```

hexdump 查看 class

```
0000000 ca fe ba be 00 00 00 3d 00 2f 0a 00 02 00 03 07
0000010 00 04 0c 00 05 00 06 01 00 10 6a 61 76 61 2f 6c
0000020 61 6e 67 2f 4f 62 6a 65 63 74 01 00 06 3c 69 6e
0000030 69 74 3e 01 00 03 28 29 56 09 00 08 00 09 07 00
0000040 0a 0c 00 0b 00 0c 01 00 1b 64 65 76 2f 73 70 69
0000050 64 65 72 2f 63 6c 61 73 73 66 69 6c 65 2f 53 69
0000060 6d 70 6c 65 01 00 02 69 64 01 00 01 49 07 00 0e
0000070 01 00 1f 6a 61 76 61 2f 6c 61 6e 67 2f 49 6c 6c
0000080 65 67 61 6c 53 74 61 74 65 45 78 63 65 70 74 69
0000090 6f 6e 09 00 10 00 11 07 00 12 0c 00 13 00 14 01
00000a0 00 10 6a 61 76 61 2f 6c 61 6e 67 2f 53 79 73 74
00000b0 65 6d 01 00 03 6f 75 74 01 00 15 4c 6a 61 76 61
00000c0 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 3b
00000d0 0a 00 0d 00 16 0c 00 17 00 18 01 00 08 74 6f 53
00000e0 74 72 69 6e 67 01 00 14 28 29 4c 6a 61 76 61 2f
00000f0 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 0a 00 1a 00
0000100 1b 07 00 1c 0c 00 1d 00 1e 01 00 13 6a 61 76 61
0000110 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 01
0000120 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a 61
0000130 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 29
0000140 56 09 00 08 00 20 0c 00 21 00 22 01 00 04 6e 61
0000150 6d 65 01 00 12 4c 6a 61 76 61 2f 6c 61 6e 67 2f
0000160 53 74 72 69 6e 67 3b 01 00 04 54 59 50 45 01 00
0000170 0d 43 6f 6e 73 74 61 6e 74 56 61 6c 75 65 03 00
0000180 00 00 01 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e
0000190 65 4e 75 6d 62 65 72 54 61 62 6c 65 01 00 05 73
00001a0 65 74 49 64 01 00 04 28 49 29 56 01 00 0d 53 74
00001b0 61 63 6b 4d 61 70 54 61 62 6c 65 01 00 07 67 65
00001c0 74 4e 61 6d 65 01 00 07 73 65 74 4e 61 6d 65 01
00001d0 00 0a 53 6f 75 72 63 65 46 69 6c 65 01 00 0b 53
00001e0 69 6d 70 6c 65 2e 6a 61 76 61 00 21 00 08 00 02
00001f0 00 00 00 03 00 19 00 23 00 0c 00 01 00 24 00 00
0000200 00 02 00 25 00 02 00 0b 00 0c 00 00 00 02 00 21
0000210 00 22 00 00 00 04 00 01 00 05 00 06 00 01 00 26
0000220 00 00 00 1d 00 01 00 01 00 00 00 05 2a b7 00 01
0000230 b1 00 00 00 01 00 27 00 00 00 06 00 01 00 00 00
0000240 06 00 01 00 28 00 29 00 01 00 26 00 00 00 51 00
0000250 02 00 03 00 00 00 14 2a 1b b5 00 07 a7 00 0e 4d
0000260 b2 00 0f 2c b6 00 15 b6 00 19 b1 00 01 00 00 00
0000270 05 00 08 00 0d 00 02 00 27 00 00 00 16 00 05 00
0000280 00 00 0d 00 05 00 10 00 08 00 0e 00 09 00 0f 00
0000290 13 00 11 00 2a 00 00 00 07 00 02 48 07 00 0d 0a
00002a0 00 01 00 2b 00 18 00 01 00 26 00 00 00 1d 00 01
00002b0 00 01 00 00 00 05 2a b4 00 1f b0 00 00 00 01 00
00002c0 27 00 00 00 06 00 01 00 00 00 14 00 01 00 2c 00
00002d0 1e 00 01 00 26 00 00 00 22 00 02 00 02 00 00 00
00002e0 06 2a 2b b5 00 1f b1 00 00 00 01 00 27 00 00 00
00002f0 0a 00 02 00 00 00 18 00 05 00 19 00 01 00 2d 00
0000300 00 00 02 00 2e
0000305
```

### Version

魔数后面跟着 小版本号和大版本号（都是2字节）

十进制转换十六进制

**echo "obase=16; 52" | bc**  

**printf '%x\n' 52** 

| 小版本 | 大版本  | 编译器版本 |
| ------ | ------- | ---------- |
| 3      | 45      | 1.1        |
| 0      | 46      | 1.2        |
| 0      | 47      | 1.3        |
| 0      | 48      | 1.4        |
| 0      | 49      | 1.5        |
| 0      | 50 0x32 | 1.6        |
| 0      | 51 0x33 | 1.7        |
| 0      | 52 0x34 | 1.8        |
| 0      | 53 0x35 | 1.9        |
| 0      | 54 0x36 | 10         |
| 0      | 55 0x37 | 11         |
| 0      | 56 0x38 | 12         |
| 0      | 57 0x39 | 13         |
| 0      | 58 0x3a | 14         |
| 0      | 59 0x3b | 15         |
| 0      | 60 0x3c | 16         |
| 0      | 61 0x3d | 17         |

Java -target 可是使用指定版本的发行版编译器进行编译。

### constant_pool

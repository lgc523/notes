---
title: "mysql逻辑架构"
date: 2022-03-09T23:14:31+08:00
draft: true
toc: false
tags: 
  - mysql
---

趁着3.8 妇女节极客时间一周免费会员，在看一遍 mysql45讲。

## 逻辑架构

整体可以分为 server 层和存储引擎层两部分。

![mysql-architechure](https://s2.loli.net/2022/03/09/PqSVheMsIw8ZHUC.png)

## timeout

客户端太长时间没有操作，连接器会自动断开，时间由参数 **wait_timeout** 控制，默认 8 小时，**interactive_timeout** 交互式连接的空闲超时。



## 链接占用

长链接：链接成功，客户端持续有请求，一直使用同一个连接。

短连接：每次执行完较少操作就断开连接，下一次操作重新建立。

Mysql 在**执行过程中临时使用的内存是管理在连接对象里面**的，**占用的资源会在连接断开的时候释放**，长链接累积下来，可能占用大量内存，被系统强行杀掉（OOM）。

- 定期断开长链接，使用一段时间或者程序判断执行过占用内存的操作后断开连接，之后在重新连接
- mysql 5.7 之后，可以在每次操作完，通过 **mysql_reset_connect 语言api** 来重新初始化连接资源，这个过程不需要重连和重新做权限验证，会将连接恢复到刚刚创建完时的状态。

## 缓存

之前执行过的**查询语句**和结果可能会以 **key-value** 的形式，被直接缓存在内存中，如果查询语句能在缓存中找到，就能直接返回 value。

只要对一个表有更新操作，表上所有的查询缓存都会被清空，查询缓存适用的场景比较局限，MySQL 8.0 删除了查询缓存功能。

参数 **query_cache_type** 设置成 **demand** ，可以对于默认的 SQL 语句都不使用查询缓存，确定要使用缓存的查询语句，可以使用 **SQL_CACHE** 显示指定。

```sql
select SQL_CACHE * from T where ID=1
```

## 分析器

没有命中缓存，开始执行语句，MySQL 分析器先对 SQL 语句做解析，知道声明的语句要做什么。

分析器先做 **词法分析**，根据规定的语句范式识别出任务，然后做 **语法分析**，判断语句是否符合 MySQL 语法。

**词法分析从 information schema 获取表结构信息。**

## 优化器

经过分析器，MySQL 明白了任务，在执行之前，要先经过优化器的处理，来权衡操作方案带来的效率，同时会验证权限。

具体会参考 扫描的行、表大小、IO 整体来决策出一个最佳的方案，**optimizer trade** 打印查询树可以看到具体的信息。

## 执行器

经过优化器，MySQL 知道具体任务要怎么做，像是 从声明式编程 变成了 命令式编程。

1. 开始执行时，先判断是否具备操作的表的权限，命中缓存会在缓存结果返回时做权限验证
2. 有权限，打开表，根据引擎定义调用引擎提供的接口
3. 进行判断，取值

## 错误语句字段不存在

Sql 执行过程中，可能存在触发器等运行时才能确定的过程，分析器不能给对运行时进行权限校验，所以需要在执行器进行权限校验。


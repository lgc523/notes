---
title: "网际层/IP地址、协议，还有字长"
date: 2021-08-29T09:39:34+08:00
draft: true
toc: true
images:
tags: 
  - net
---

网际层是 TCP/IP协议的第二层，提供独立于硬件的路基寻址，从而让数据能够在具有不同物理结构的子网之间传递(基于IP协议提供的IP地址实现)。

## IP地址

``Internet Protocol Address``

互联网上每一个网络和每一台主机会分配一个逻辑地址，以此来屏蔽物理地址的差异。

### 为什么使用IP地址

单个局域网内，计算机之间可以使用网络层提供的MAC地址进行通信。如果是在路由式网络中，计算机之间进行通信就不能利用MAC地址实现数据传输，因为MAC地址不能跨路由接口运行。即使强行实现跨越，使用MAC地址传输数据也是非常麻烦的。是因为在内置的网卡里固定的MAC地址不能在地址空间上引入逻辑结构，使其无法具备真正的地址来表示国家、省、市、区 ...... 这类层次。因此，要进行数据传输，必须采用一种逻辑化、层次化的寻址方案对网络进行组织，就是IP地址。

### MAC内网通信

两台计算机在一个网络内，连接一个交换机，通过MAC地址就可以找到对方，数据桢首部的目标地址和源地址就是MAC地址。

交换机收到这个桢，查看自己的转发表(一列MAC地址，一列MAC地址对应的端口)，找到就将数据从该MAC对应的端口转发出去，没找到，交换机就会想所有端口广播(除了该桢进入的端口)。

### 跨网IP通信

如果两台计算机不在一个网络内，本机的网络层就认为数据应该发送给网关，把数据发送出网络，网关相当于网络的守卫，要想把数据发给网关，同样需要知道网关的MAC，通过ARP表(一列IP地址，一列MAC地址，网卡通信数据累加) 如果获取网关对应的MAC地址，就转化为内网数据发送。如果ARP表内没有网关IP地址对应的MAC地址，就启动ARP协议，内网广播，询问该IP地址的MAC地址。广播地址询问的结果是网关收到广播后发现是找自己的MAC地址，就回复自己的MAC地址，然后数据发给网关，还是先要内网发送数据到网关。

跨网通信需要IP地址来判断是内网通信还是外网通信，而MAC地址出厂就被确定，没有确定的网络，不能够区分网络的特性。

MAC只负责设备到设备的通信就够了，内网通信才是真正的通信，被称为物理通信。

跨网络通信时，需要考虑传输的路径，为了到达目的地，下一跳应该去哪，从而一跳一跳的传输到目的地。内网传输不需要考虑传输路径，只要发出去就一定可以到达。最坏情况就是通过广播传输。跨网络传输时需要考虑网络之间的传输，需要使用能够保湿网络特征的地址，所以IP地址是负责网络到网络传输的。

### 探测局域网内主机

```
netwox 3 -a ip/24  扫到一台华为保时捷
```

### 探测主机ip

```
主机也可以做服务器
netwox 3 -a www.163.com
在北京探测
42.81.228.11-13 天津电信
```

## IP地址构成

``为了保证数据能够正确的发送到目标主机上，IP地址必须有一定的规则来识别主机的位置``

### 基本构成

为了便于寻址，每个IP地址包括两个识别码(ID)，网络ID和主机ID。

同一个物理网络上的所有主机都使用同一个网络ID，网络上的主机、设备有一个主机ID与其对应

- 网络ID 识别主机所在的网络，占用字节/几类地址 决定了可以划分多少个网络
- 主机ID 识别网络中的主机，主机ID决定了网络中的最大主机数量

IP地址为32位地址，分为4个8位段，为了更好的区分

- A类 网络位:主机位 1:3 网络位 0xxxxxx          0.0.0.0～127.255.255.255
- B类 网络位:主机位 1:1 网络位 10xxxxxx       128.0.0.0~191.255.255.255
- C类 网络位:主机位 3:1 网络位 110xxxxx       192.0.0.0~223.255.255.255
- D类 不分网络ID和主机ID，用于多播 网络位 224.0.0.0~239.255.255.255
- E类  不分网络ID和主机ID，用于实验            240.0.0.0～255.255.255.254

### 特殊IP地址

- ###### A类地址

  - 私有地址范围 10.0.0.0～10.255.255.255
  - 保留地址范围 127.0.0.0～127.255.255.255

- B类地址

  - 私有地址范围 172.16.0.0～172.31.255.255
  - 保留地址 169.254.X.X

- C类地址

  - 私有地址范围192.168.0.0～192.168.255.255

- 网络地址 主机位为0，网络地址标识网络本身

- 广播地址 主机号全部为1,255

- 有限广播地址 32位全，255.255.255.255 用于本网广播

- 测试地址 网络地址不能以十进制的127开头，保留给系统测试用

- 0.0.0.0 表示不清楚主机和目的网络

### 子网划分

为了能够在大型网络中实现更高效的传输，需要进行子网划分，将网络划分为更小的网络，将IP地址的主机ID划分为子网ID和主机ID，子网ID用来寻找网络内的子网:主机ID用来寻找子网中的主机，子网掩码知名地址中有多少位用于子网ID，保留多少位用于实际的主机ID。

RFC 950 定义了子网掩码的使用，32位二进制数，其对应网络地址所有位置都为1,对应于主机地址的所有位都为0

A类地址默认的子网掩码是 255.0.0.0

子网掩码和IP地址 & ,得到IP地址的网络地址，剩下的就是主机地址，可以区分出IP地址中网络地址和主机地址。

### CIDR格式

将IP地址分为A类、B类、C类后，会造成IP地址的部分浪费，一些连续的IP，一部分属于A类地址，一部分数据B类地址，为了使这些地址聚合以方便管理，出现了CIDR(无类域间路由)。

无类域间路由(Classkess Inter-Domain Routing，CIDR) 可以将路由集中起来，在路由表中更灵活定义地址，不区分几类地址，使用CIDR 前缀的值指定地址中作为网络中的位数。

205.123.196.183/25 25位用于网络ID，相应的掩码为 255.255.255.128。

已知 CODR 格式地址 192.168.1.32/27 计算掩码并显示包含多少主机

27-24=3 ,32-> 0010,0000 五位表示主机位 全1=2^5-1=31

```
#列出包含的所有主机
netwox 213 -i 192.168.1.32/27
192.168.1.32
192.168.1.33
192.168.1.34
192.168.1.35
192.168.1.36
192.168.1.37
192.168.1.38
192.168.1.39
192.168.1.40
192.168.1.41
192.168.1.42
192.168.1.43
192.168.1.44
192.168.1.45
192.168.1.46
192.168.1.47
192.168.1.48
192.168.1.49
192.168.1.50
192.168.1.51
192.168.1.52
192.168.1.53
192.168.1.54
192.168.1.55
192.168.1.56
192.168.1.57
192.168.1.58
192.168.1.59
192.168.1.60
192.168.1.61
192.168.1.62
192.168.1.63
```

```
#计算IP的掩码
netwox 24 -i 192.168.1.32/27
192.168.1.32-192.168.1.63 		#ip 地址范围
192.168.1.32/27								
192.168.1.32/255.255.255.224  #掩码
```

## IP协议

IP地址提供了一种分层的、与硬件无关的寻址系统，可以在复杂的路由式网络中传递数据所需的服务。IP地址可以将多个交换网络连接起来，在源地址和目的地址之间传送数据包，同时还提供重新组装功能，以适应不同网络对数据包大小的要求。

### 工作方式

- 同网段

  如果源地址主机和目标地址在同一网段，目标地址被 ARP 协议解析为 MAC 地址，然后根据 MAC 地址，源主机直接把数据包发给目标主机。

- 不同网段

  1. 网关IP地址被 ARP 协议解析为 MAC 地址，源主机将数据包发送到网关
  2. 网关根据数据包中的网段ID 寻找目标网络，如果找到，将数据包发送到目标网段，没找到，重复步骤1将数据包发送到上一级网关。
  3. 数据包经过网关被发送到正确的网段中，目标IP地址被 ARP 协议 解析为MAC地址，数据包被发送给目标主机

### IP数据包结构

IP协议传输的数据的包被称为IP数据包，每个数据包都包含IP协议规定的内容，IP协议规定的这些内容被称为IP数据报文、IP数据报。

IP数据报文由首部和数据两部分组成，首部的前一部分是固定长度，共20字节，是所有IP数据报必须具有的，首部固定部分的后面是一些可选字段，其长度是可选的。

每个IP数据报都以一个IP报头开始，源计算机构造这个IP报头，目的计算机利用IP报头中封装的信息处理数据。IP报头中包含大量信息，每个信息都被称为一个字段，IP报头的最小长度为20字节，

- 版本 

  占四位，表示IP协议的版本，通信双方使用的IP协议版本必须一致

- 首部长度 (IHL)

  网际报头长度IHL，占四位，可表示的最大十进制数是15，这个字段所表示的数的单位是32字长(1个32位字长是4字节)。当IP的首部长度为1111，首部长度就达到60字节。当IP分组的首部长度不是4字节的整数倍时，必须利用最后的填充字段填充。数据部分永远在4字节的整数倍开始，这样在实现IP协议是比较方便。首部长度限制为60字节的缺点是，长度有时会不够用，之所以限制长度为60字节，是希望用户尽量减少开销。最常用的首部长度就是20字节(0101)，这时不使用任何选项。

- 区分服务(tos)

  服务类型，占8位，用来获得更好的服务，只有在使用区分服务时，这个字段才起作用。

- 总长度 (tootles)

  首部和数据之和，单位为字节，总长度字段为16位，因此数据报的最大长度为 2^16-1=65536 字节

- 标识

  用来标识数据报，占16位，IP协议在存储器中维持了一个计数器。每产生一个数据报，计数器就加1,并将此值赋值给标识字段。当数据报的长度超过网络的MTU，而必须分片时，这个标识字段的值就被复制到所有的数据报的标识字段中，具有相同的标识字段值的分片报文会被重组成原来的数据报。

- 标志

  占三位

  第一位未使用，其值为0

  第二位为DF(不分片)，表示是否允许分片。

  - 取值为0时，表示允许分片

  - 取值为1时，表示不允许分片

  第三位称为MF(更多分片)，表示是否还有分片正在传输，设置为0时，表示没有更多分片需要发送，或数据报没有分片

- 片偏移 offsetfrag

  占13位，当报文被分片后，该字段标记该分片在原报文中的相对位置。片偏移以8字节为偏移单位，除了最后一个分片，其他分片的偏移值都是8字节的整数倍。

- 生存时间 TTL

  表示数据报在网络中的寿命，占8位。该字段由发出数据报的源主机设置。目的是防止无法交付的数据报无限制地在网络中传输，从而消耗网络资源。路由器在转发数据报之前，先把TTL值减1。若TTL值减少到0，则丢弃这个数据报，不再转发。

  TTL指明数据报在网络中最多可经过多少个路由器，TTL的最大值位255，若把TTL的初始值设为1，则表示这个数据报只能在本局域网中传输。

- 协议

  表示该数据报文所携带的数据所使用的协议类型，占8位。该字段可以方便目的主机的IP层知道按照什么协议来处理数据部分，不同的协议有专门不同的协议号。

- 首部检验和 checksum

  用于校验数据报的首部，占16位。数据报每经过一个路由器，首部的字段都可能发生变化(eg:TTL)，所以需要重新校验。数据部分不发生变化，所以不用重新生成校验值。

- 源地址

  表示数据报的源IP地址，占32位

- 目的地址

  表示数据报的目的IP地址，占32位，用于校验发送是否正确

- 可选字段

  用于一些可选的报头设置，主要用于测试、调试和安全的目的，这些选项包括严格源路由(数据报必须经过指定的路由)、网际时间戳(经过每个路由器时的时间戳记录)和安全限制。

- 填充

  由于可选字段中的长度不是固定的，使用若干个0填充该字段,可以保证整个报头的长度是32的整数倍。

- 数据部分

  表示传输层的数据，eg:TCP、UDP、ICMP的数据。

### 构建IP数据包

```
$ netwox 38
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen             |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________|
|              id               |r|D|M|       offsetfrag        |
|_________0x7B23=31523__________|0|0|0|________0x0000=0_________|
|      ttl      |   protocol    |           checksum            |
|____0x00=0_____|____0x00=0_____|____________0x6022_____________|
|                            source                             |
|________________________192.168.18.239_________________________|
|                          destination                          |
|____________________________5.6.7.8____________________________|
```

```
$ netwox 38 -l 192.168.59.132 -m 192.168.12.101
IP______________________________________________________________.
|version|  ihl  |      tos      |            totlen             |
|___4___|___5___|____0x00=0_____|___________0x0014=20___________|
|              id               |r|D|M|       offsetfrag        |
|_________0x8A37=35383__________|0|0|0|________0x0000=0_________|
|      ttl      |   protocol    |           checksum            |
|____0x00=0_____|____0x00=0_____|____________0x6779_____________|
|                            source                             |
|________________________192.168.59.132_________________________|
|                          destination                          |
|________________________192.168.12.101_________________________|
```

### 字、字长

- 字 Word

  16个位(Bit) 位一个字，两个字节为一个字，代表计算机处理指令或数据的二进制位数，是计算机数据存储和数据处理的运算单位。而位(Bit)是计算机存储处理信息的最基本的单位。

- 字长

  字的位数，不同档次的机器又不同的字长，8位机，一个字就等于一个字节，字长为8，一台16位机，一个字就由两个字节构成，字长为16位。






---
title: "ICMP"
date: 2021-08-31T00:38:43+08:00
draft: true
toc: true
images:
tags: 
  - net
---

控制报文协议 Internet Control Message Portocol 是TCP/IP协议族的一个子协议，ICMP 协议用在IP主机和路由之际爱你传递控制信息，描述网络是否通畅、主机是否可达、路由器是否可用等网络状态。

## 作用

数据包在发送到目标主机的过程中，通常会经过一个或多个路由器，而数据包在通过这些路由进行传输时，可能会遇到各种问题，导致数据包无法发送到目标主机上，为了了解数据包在传输过程中哪个环节出现了问题，就需要用到ICMP协议，跟踪消息将问题反馈给源主机。

## 报文结构

ICMP 报文一般为8个字节，包括类型、代码、校验和拓展内容字段。

- 类型 

  1字节，表示消息类型

- 代码

  1字节，表示对类型的进一步说明

- 校验和

  2字节，表示对整个报文信息的校验，ICMP报文中，如果类型和代码不同，ICMP数据包报告的消息含义也会不同

常见的类型和代码

| 类型 | 代码 | 含义                        |
| ---- | ---- | --------------------------- |
| 0    | 0    | 回显应答(ping应答)          |
| 3    | 0    | 网络不可达                  |
| 3    | 1    | 主机不可达                  |
| 3    | 2    | 协议不可达                  |
| 3    | 3    | 端口不可达                  |
| 3    | 4    | 需要进行分片，但设置不分片  |
| 3    | 5    | 源站选路失败                |
| 3    | 6    | 目的网络未知                |
| 3    | 7    | 目的主机未知                |
| 3    | 9    | 目的网络被强制禁止          |
| 3    | 10   | 目的主机被强制禁止          |
| 3    | 11   | 由于服务类型TOS，网络不可达 |
| 3    | 12   | 由于服务类型TOS，主机不可达 |
| 3    | 13   | 由于过滤，通信被强制禁止    |
| 3    | 14   | 主机越权                    |
| 3    | 15   | 优先终止生效                |
| 4    | 0    | 源端杯关闭(基本流控制)      |
| 5    | 0    | 对网络重定向？              |
| 5    | 1    | 对主机重定向                |
| 5    | 2    | 对服务类型和网络重定向      |
| 5    | 3    | 对服务类型和主机重定向      |
| 8    | 0    | 回显请求(ping请求)          |
| 9    | 0    | 路由器通告                  |
| 10   | 0    | 路由器请求                  |
| 11   | 0    | 传输期间生存时间为0         |
| 11   | 1    | 在数据报组装期间生存时间为0 |
| 12   | 0    | 坏的IP首部                  |
| 12   | 1    | 缺少必需的选项              |
| 13   | 0    | 时间戳请求                  |
| 14   | 0    | 时间戳应答                  |
| 17   | 0    | 地址掩码请求                |
| 18   | 0    | 地址掩码应答                |

## 路由跟踪

路由跟踪是用来识别一个设备到另一个设备的网络路径，在一个简单的网络上，这个网络路径可能只经过一个路由器，甚至一个都不经过。在复杂的网络中，数据包可能可能要经过十个路由器才会到达最终目的地，可以通过路由跟踪功能判断数据包的传输路径。

traceroute  命令用来检测发出数据包的主机到目标主机之间所经过的网关，通过设置探测包的TTL值，跟踪数据报到达目标主机所经过的网关，并监听来自网关ICMP的应答。

```
$ traceroute www.qq.com
traceroute: Warning: www.qq.com has multiple addresses; using 42.81.176.157
traceroute to ins-r23tsuuf.ias.tencent-cloud.net (42.81.176.157), 64 hops max, 52 byte packets
 1  link.zihome.com (192.168.18.1)  3.484 ms  3.459 ms  3.268 ms
 2  192.168.1.1 (192.168.1.1)  4.657 ms  3.810 ms  3.984 ms
 3  100.92.0.1 (100.92.0.1)  7.429 ms  6.245 ms  7.113 ms
 4  36.112.252.185 (36.112.252.185)  6.258 ms  6.843 ms  6.674 ms
 5  36.112.241.65 (36.112.241.65)  7.624 ms * *
 6  42.81.32.138 (42.81.32.138)  17.089 ms
    42.81.35.30 (42.81.35.30)  10.669 ms
    42.81.32.222 (42.81.32.222)  25.867 ms
 7  * * *
 8  * * *
 9  * * *
10  * * *
11  * * *
12  9.121.252.83 (9.121.252.83)  20.721 ms
    9.121.251.247 (9.121.251.247)  14.094 ms
    9.121.252.87 (9.121.252.87)  13.320 ms
```

记录从序号1开始，每个记录就是一跳，每一跳对应一个网关，记录显示了每个网关对应的IP地址，*** 记录表示可能被防火墙拦截的ICM p的返回信息。

## ICMP时间戳请求

ICMP 时间戳请求允许系统向另外一个系统查询当前的时间，不包含日期。返回的建议值是自午夜零点开始计算的时间(UTC)。

请求端填写发起时间戳，然后发送报文，应答系统收到请求报文时填写接收时间戳，在发送应答时填写发送时间戳

```
netwox 81 -i ip
```


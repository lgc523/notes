---
title: "ARP"
date: 2021-08-30T23:58:17+08:00
draft: true
toc: true
images:
tags: 
  - net
---

地址解析协议 Address Resolution Protocol，ARP,是根据IP地址获取物理地址的一个TCP/IP协议，通过IP地址向MAC地址的转换，解决网际层和网络访问层的衔接问题。

ARP协议是数据传输的必备协议，主机发送信息前，必须通过ARP协议获取目标IP地址对应的MAC地址，才能正确发送数据包。

## 为什么需要ARP

网络访问层中，同一局域网中的一台主机要和另外一台主机进行通信，需要通过MAC地址进行定位，然后才能进行数据包的发送。

在网络层和传输层中，计算机之间是通过IP地址定位目标主机，对应的数据报文只包含目标主机的IP地址，而没有MAC地址。因此，在发送前需要根据IP地址获取MAC地址，然后才能将数据包发送到正确的目标主机，这个获取过程是通过ARP协议完成的。

## 基本流程

ARP流程分为 请求过程 和 响应过程

主机A 以广播形式向网络中所有主机发送ARP请求，请求包中包含了目标IP地址主机B

主机B接收到请求，发现自己就是主机A要找的主机，返回响应，响应包中包含自己的MAC地址。

## ARP缓存

为了避免重复发送ARP请求，每台主机都有一个ARP高速缓存。当主机得到ARP响应后，将目标主机的IP地址和物理地址存入本机ARP缓存中，并保留一段时间。只要在这个时间范围内，下次请求MAC地址时，直接查询ARP请求，无须再次发送ARP请求。

有了ARP缓存后的流程

1. 主机A在本机ARP缓存中检查主机B的匹配MAC地址
2. 如果在ARP缓存中没有找到主机B的IP地址及对应的MAC地址，将询问主机B的MAC地址，从而将ARP请求桢广播到本地网络上的所有主机。源主机A的IP地址和MAC地址都包含在ARP请求中。
3. 本地网络上的每台主机都接收到ARP请求，并且检查是否与自己的IP地址匹配，如果主机发现请求的IP地址与自己的IP地址不匹配，它将丢弃ARP请求。主机B确定ARP请求中的IP地址与自己的IP地址匹配，则将主机A的IP地址和MAC地址映射添加到本地缓存。
4. 主机B将包含自身MAC地址的ARP回复消息直接发送给主机A
5. 当主机A收到从主机B发来的ARP回复消息时，会用主机B的IP地址和MAC地址更新ARP缓存
6. 主机B的MAC地址一旦确定，主机A就能向主机B发送IP数据包。本机缓存是有生存期的，生存期结束，将再次重复上面的过程。

## 查看ARP缓存

```
$ arp -a
? (169.254.38.192) at (incomplete) on en0 [ethernet]
link.zihome.com (192.168.18.1) at 80:12:df:91:32:b8 on en0 ifscope [ethernet]
? (192.168.18.162) at 52:62:d7:96:72:34 on en0 ifscope [ethernet]
? (224.0.0.251) at 1:0:5e:0:0:fb on en0 ifscope permanent [ethernet]
? (239.255.255.250) at 1:0:5e:7f:ff:fa on en0 ifscope permanent [ethernet]
```

ping  ip 后就会添加目标IP和MAC地址到缓存中(尽管没通)

## ARP协议包结构

ARP协议包主要分为ARP请求包和ARP响应包

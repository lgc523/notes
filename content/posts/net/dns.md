---
title: "Domain Name System"
date: 2021-12-01T00:32:43+08:00
draft: true
toc: true
images:
tags: 
  - net
---

``RFC1035 DNS and protocol ``

> https://datatracker.ietf.org/doc/html/rfc1035

TCP/IP 网络通过 IP 地址来确定通信对象(网卡)，IP 地址不方便人类读写，服务器名称就容易很多了。

**如果 Web 服务器使用了虚拟主机功能，有可能无法通过 IP 地址来访问。**

域名可能比 IP 地址长的多(<=255)，**对中间网络设备有一定的压力**，DNS 机制同时方便了人类和机器的读写、转换，**是一个将域名和 IP 地址相互映射的分布式缓存数据库**。

但是 **DNS 的功能并不仅限于域名和 IP 关联**，还可以关联 邮件地址和邮件服务器，以及为各种信息关联相应的名称。

## 基本工作原理

### 接受客户端的查询请求

客户端查询消息内容

- 域名

- Class 

  最早的方案，DNS 在互联网以外的其他网络中的应用也被考虑到，用来识别网络信息，现在永远代表互联网 **IN**

- 记录类型

  表示域名对应何种类型的记录

  - A             Address 域名指向 IP 地址
  - CNAME 域名指向域名，在由另外一个域名提供 IP 地址
  - MX          Mail eXchange 域名对应邮件服务器
  - NS          将子域名交给其他 DNS 服务商解析
  - AAAA     将于明指向一个 IPv6 地址
  - SRV        服务定位器，用来标识某台服务器使用了某个服务，常见于微软系统的目录管理
  - TXT        对域名进行标识和说明，绝大多数 TXT 记录是用来做 SPF 记录(反垃圾邮件) 

  上面常用记录类型参考 cloud.tencent，更多可以参考维基百科 。

  > https://cloud.tencent.com/document/product/302/38661
  >
  > https://zh.wikipedia.org/wiki/DNS%E8%AE%B0%E5%BD%95%E7%B1%BB%E5%9E%8B%E5%88%97%E8%A1%A8

### DNS 资源记录表（TTL）

| 域名             | Class | 记录类型 | 响应数据 |
| ---------------- | ----- | -------- | -------- |
| liguangchang.cn  | IN    | A        | 1.2.3.4  |
| liguangchang.cn. | IN    | MX       | 1.2.3.4  |

DNS 根据域名查询对应表中的记录进行响应（**可能是多条**）

**MX 记录类型，存在优先级，一个邮件地址对应多个邮件服务器时，需要根据游戏那集判断哪个邮件服务器是优先的，优先级数值越小越优先。**

### 层次结构

由于互联网网络设备数量的庞大，DNS 服务器通过划分层次结构来管理大量的信息。

**域名用 句号 分隔出不同层次之间的界限，越靠右的位置层级越高，默认省略的根域名 .**

**分层结构就出现了上下级域，上级域管理子域的 DNS 服务器的 IP 地址，将子域的 服务器 IP 地址注册到自己的 DNS 服务器中，自底向上注册，这样顶层的根域就可以向下按照划分的域来匹配出域名对应的 IP 地址。**

另外所有的 DNS 服务器需要存储 根域的 DNS 服务器信息，这样客户端通过找到最近的一台 DNS 服务器都可以找到根域 DNS 服务器，自顶向下的匹配出目标 DNS 服务器得以找出 IP 。

分配给根域 DNS 服务器的 IP 地址在全世界仅有 13 个（一个 IP 下有多台服务器），13 个服务器几乎不发生变化。

### 请求过程（*recursive*）

如果要请求的域名是 www.liguangchang.cn

1. 客户端请求最近的 DNS 服务器
2. 最近的 DNS 服务器存储有根域 DNS 服务器，将请求转发
3. 根域 DNS 服务器此时就是多叉树的根节点，根据域名结构可以判断出第一级的域 cn，响应 cn 域的 IP 地址
4. 客户端收到响应，询问 cn 域 DNS 服务器，repeat
5. 直到 www.liguangchang.cn

### 缓存加速

上面是 DNS 工作的基本原理，真是互联网中工作方式，一台 DNS 服务器可以管理多个域的信息，并不是每一个域都有一台 DNS 服务器，**中上级域 和 下级域 可能共享一台 DNS服务器，这样就可以直接返回下一级 DNS 服务器的信息**。

DNS 服务器的缓存功能，进一步减少了多次询问，并且**查询域名不存在时，不存在响应结果也会被缓存**。

**注册信息改变，缓存信息可能不是正确的，缓存也是需要设置 TTL 的，DNS 服务器会告知客户端这一响应的结果是来自缓存中还是负责管理改域名的 DNS 服务器**。

**平时编码可以根据实际场景是否将空记录写入缓存，或者将空记录写入缓存设置较小的 TTL，根据实际情况 trade off。**

## 解析切流量

因为缓存的存在，修改域名解析记录DNS缓存服务器不可能立即生效，权威 DNS服务器可以立即生效，为了防止数据流向错误，可以提前将域名解析记录 TTL 改小。

## 本地 DNS 缓存

``/etc/resolv.conf``      ``generated by /usr/sbin/dhclient-script``    ``script use DHCP client``

## DNS 报文

``wireshark + options trace``

## dig

``DNS lookup utility``    ``defult port 53(UDP)，可以是 TCP``

```
dig [@server] [-b address] [-c class] [-f filename] [-k filename] [-m] [-p port#] [-q name] [-t type] [-v] [-x addr] [-y [hmac:]name:key] [[-4] | [-6]] [name] [type] [class] [queryopt...
```

- support batch mode   ``-f file``
- 没有指定 name sercer，会解析 /etc/resolv.conf 找 DNS 服务期地址，没有可用的服务地址，会请求本地.

```
type dig
dig is /usr/bin/dig
```

### default A/short display

``dig liguangchang.cn [A/AAAA/CNAME] 默认查询 A类型记录``

```
dig +short liguangchang.cn 只输出ip
[+nocomments +noquestion +noauthority +noadditional +nostats]
[+noall +answer] 更简洁 
[+noall +answer +ttlid] 单位 秒
dig +noall +answer +ttlid liguangchang.cn
```

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.3 <<>> liguangchang.cn
;; global options: +cmd
;; Got **answer**:
;; ->>HEADER<<- opcode: QUERY, **status**: **NOERROR**, id: 8790
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

;; **QUESTION** **SECTION**:
;liguangchang.cn.		IN	A

;; **ANSWER SECTION**:
liguangchang.cn.	600	IN	A	49.232.212.110

;; Query time: 67 msec
;; SERVER: 183.60.82.98#**53**(183.60.82.98)
;; **WHEN**: Thu Dec 02 00:58:34 CST 2021
;; MSG SIZE  rcvd: 49

### 指定服务器

```
dig @8.8.8.8 liguangchang.cn
不指定会从 /etc/resolv.conf 查询
```

### 反向查询DNS 

```
dig -x 8.8.8.8 +short
dns.google.
```

### trace

```
dig +trace liguangchang.cn
```

### 13 根域名服务器（IP）

```
$ dig . NS

; <<>> DiG 9.10.6 <<>> . NS
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 13777
;; flags: qr rd ra; QUERY: 1, ANSWER: 13, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;.				IN	NS

;; ANSWER SECTION:
.			442720	IN	NS	k.root-servers.net.
.			442720	IN	NS	m.root-servers.net.
.			442720	IN	NS	c.root-servers.net.
.			442720	IN	NS	d.root-servers.net.
.			442720	IN	NS	j.root-servers.net.
.			442720	IN	NS	b.root-servers.net.
.			442720	IN	NS	l.root-servers.net.
.			442720	IN	NS	a.root-servers.net.
.			442720	IN	NS	h.root-servers.net.
.			442720	IN	NS	i.root-servers.net.
.			442720	IN	NS	e.root-servers.net.
.			442720	IN	NS	g.root-servers.net.
.			442720	IN	NS	f.root-servers.net.

;; Query time: 6 msec
;; SERVER: 192.168.18.1#53(192.168.18.1)
;; WHEN: Wed Dec 01 02:01:23 CST 2021
;; MSG SIZE  rcvd: 228
```



## DNS Hijacking

路由器作为局域网网络用户的 DNS 代理缓存服务器，支持本地域名配置，一旦被攻击，篡改记录，可能不知不觉中访问到钓鱼网站，暴露个人隐私。

加强设备安全巡检 + 合法不可伪造的证书，可以有效避免被挟持的风险。

## jmDNS



## 携带根域名访问

今天发现很多网站地址访问加上根域名就会出现 403、415、CORS、404、网页不安全的问题，主要是用了证书，证书和域名绑定，如果直接访问带根域名的域名，DNS 解析是没有问题的，但是证书和域名不匹配或者跨域问题，就会导致访问异常，其实大多数人不会这么访问，但是一些细心的企业或者个人还是做了一些东西，简单的就是将前置正向代理对携带根域名的域名进行 301。

有些因为域名和证书不匹配，ssl_err 的，通过 curl -v 发现响应 308 Permanent Redirect。

## HTTP 3xx

**RFC 2616，7231， 6585，7538，1945，2068**

```
This document defines the semantics of HTTP/1.1 messages, as expressed by request methods, request header fields, response status codes, and response header fields, along with the payload of messages (metadata and body content) and mechanisms for content negotiation.
```

- 300 Multiple Choices

- 301 Moved Permanently

  **表示当前 URI 永久指向了一个新的 URI，并且要求服务端应该生成一个 Location 放在 header 中响应。**

  之前对接外部接口，就有一个认证接口，需要在一个接口里面请求外部两次，外部服务对第二次请求会进行重定向，当时还想着让前端去触发第二次请求。。。

- 302 Found

  临时变更 Location，客户端还要继续请求之前的 URI，user agent may use location  automatic redirectin (POST 可能会转 GET)，

  和前端调试接口，有时候就会出现 POST 转 GET 的错误，前端用了代理。

- 303 See other

  表示请求的资源对应的资源存在着另一个 URI，应该使用 GET/HEAD 方法定向获取请求另外一个 URI。

  301，302，303 状态响应，大部分浏览器都会把 POST 改为 GET，并删除请求报文主体，再次发起请求。

  301，302 标准是禁止将 POST 方法改变成 GET 方法，但是大部分都是 GET 请求返回的 Location。

- 304 Not Modified

  表示客户端发送附带条件的 GET 请求时，服务端允许请求访问资源，因为发生请求未满足条件的情况后，直接返回 304 ,和重定向没关系。

- 305 Use Proxy（depreccated）

- 306 Unused （代码保留，不再使用）

- 307 Temporary Redirect

  临时重定向，和302 相同， 会禁止 POST 变换成 GET方法。

- 308 Permanent Redirect

  RFC 7583 补充提出

  ```
  Note: This status code is similar to 301 (Moved Permanently)
        ([RFC7231], Section 6.4.2), except that it does not allow changing
        the request method from POST to GET.
  ```

## Trade-off

- http1.0 ，RFC 1945，302 = Moved Temporarily，浏览器处理 302 会自动把 POST 转 GET。
- http1.1，RFC 2068，尝试制定标准，浏览器厂商不改。
- RFC 2616 修改了标准，302 = Found，增加了 303，307，浏览器照旧处理 302，






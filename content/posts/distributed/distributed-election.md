---
title: "Distributed leader election"
date: 2021-10-14T00:00:39+08:00
draft: true
toc: true
images:
tags: 
  - distributed
---

分布式系统集群中，选举出来的 leader 节点负责对其他节点的协调和管理，保证集群内节点有序运行和数据的一致性，记录一些选主的算法。

### Bully

**在所有存活的节点中，选取ID最大的节点作为主节点**。(默认前提:每个节点知道其他节点的ID)

- 节点角色

  节点的角色有 **主节点和普通节点**，初始化时所有节点平等，都是普通节点，都有成为主节点的权利，主节点只有一个，当且仅当主节点故障或者与其他节点失去联系后，才会重新选主。

- 选举涉及到的消息

  - Election 消息，用于发起选举
  - Alive 消息，对 Election 的应答
  - Victory 消息，竞选成功的主节点向其他发送宣誓主权的消息

- 选举过程

  1. 集群内每个节点判断自己的ID是否为当前存活节点的最大ID，如果是，向其他节点发送 Victory，宣示主权
  2. 当前节点的ID如果不是当前存活节点中最大ID，向比自己ID大的节点的所有节点发送 Election 消息，等待其他节点回复
  3. 一定时间内，当前节点没收到其他节点的回复Alive消息，则认为自己为主节点，向其他节点发送Victory 消息，宣誓自己成为主节点
  4. 如果收到比自己ID大的节点发送的Alive消息，则等待其他节点发送Victory消息
  5. 如果收到比自己ID小的节点发送的Election消息，则回复Alive消息，告知其重新选举

  普通节点变成主节点的选举过程，不参与选举(不向对其他人投票)，只会同步其他节点victory 消息，有一点倚老卖老的感觉。

  如果对集群内节点递增编号，从1到n，集群全部存活的情况下，最后最大的id n 成为了主节点

  那么每一步选举产生的消息量

  1. n 节点发送 n-1 条 victory 消息
  2. n-1 个节点选举比自己ID打的节点，发送 (n^2 - n)/2 条 Electoion 消息
  3. 最大ID节点 n ，再次发送 victory 消息，宣誓主权
  4. 
  5. n-1 个中间节点会收到ID大于自己ID的节点发送 Alive 消息 (n2+n)/2

  所有节点之间通信量还是很大的，选举过程遇到故障节点，通信量、和选举时间都会随之增加。

  Bully 算法选举速度快，简单易实现，但是每**个节点需要维护集群内所有节点的信息**，**任意一个比当前主节点ID大的新节点或节点故障后恢复加入集群的时候，都可能会出发重新选举，成为新的主节点**，如果频繁退出、加入集群，就会导致频繁切主。

  **MongoDB 的副本集故障转移功能，就是采用 Bully 算法，采用节点的最后操作时间戳来表示ID，时间戳最新的阶段ID最大。**

### Raft

**少数服从多数，获得投票最多的节点成为主节点。**

- ###### 节点角色

  - Leader，主节点，同一时刻只能有一个 leader
  - Candidate，候选节点，每个节点都可以成为 Candidate，Candidate 节点才有可能成为 Leader
  - Follower，Leader 的跟随者，不能发起选举

- 选举流程

  - 初始化时，所有节点都是 Follower
  - 开始选举，**所有节点从 Follower 转化为 Candidate ，并向其他节点发送选举请求**。
  - 其他节点根据**收到的选举先后顺序**，回复是否同意成为 Leader （**每一轮选举中，一个节点只能投出一票**）。
  - 若某一个节点**获得超过一半的投票**，则转化为 Leader，**其他节点从 Candidate 降为 Follower** ，Leader 与 Follower 节点之间会定期发送心跳包，检测主节点是否存活。
  - Leader 任期到了(发现其他节点开始下一轮选举)，**Leader 节点的状态转化为 Follower** ，进入新一轮选主（**正常周期性选举**）。

  Raft 选举速度快，易于实现，要求节点可以相互通信，并且要获得半数以上的投票数才能选出 Leader，通信量大，**稳定性比Bully 好，新节点加入或者节点故障恢复后，会触发选主，但是不一定会切主，除非新节点货故障后恢复的节点获得半数以上投票。**

Bully 像是不公平的选主，Raft 像是公平的选主，下面的 ZAB 像是可以控制的优先队列，秒啊。

### ZAB

**具有优先级的民主选举算法**

Zookeeper Atomic Broadcast ，为了Zookeeper 实现分布式协调功能设计的，相对于Raft **增加了通过节点ID和数据ID作为参考选主**，**节点ID和数据ID越大，表示数据越新，优先成为主，尽可能保证数据的最新性**。

这样可以通过水平拓展机器的数量来控制迁移主节点，Raft 主节点可能水平拓展也不会改变主节点，人类总喜欢去掌控所有能够掌控的。

- **节点角色**
  - **Leader 主节点**
  - **Follower 跟随者节点**
  - **Observer 观察者，无投票权**
- **选举过程状态变化**
  - Looking 状态，选举状态，当节点处于该状态，会认为当前集群没有 Leader，因此自己进入选举状态
  - Leading 状态，领导者，已经选出主，当前节点为Leader
  - Following 状态，跟随着状态，集群有主，其他非主节点状态更新为Following，表示对 Leader 的追随
  - Observing 状态，观察者模式，表示当前节点为 Observer，持观望态度，没有投票权和选举权

投票过程中，每个节点都有一个唯一的三元组（server_id，server_zxID，epoch）

1. **server_id 表示节点的唯一ID**
2. **server_zxID 表示本节点存放的数据ID，数据ID越大表示数据越新，选举权重越大**
3. **epoch 表示当前选举轮数，一般用逻辑时钟表示**

ZAB 选举算法的核心是少数服从多数，ID大的节点优先成为主，选举过程中通过 **(vote_id，vote_zxID)** 来表明投票给哪个节点，**vote_id** 表示被投票节点的ID，**vote_zxID** 表示被投票节点的服务器 zxID。

**选主原则: server_zxID 最大者称为 Leader，若 server_zxID 相同，server_id 最大者成为 Leader** 

- **选举过程**
  - 系统启动，所有节点处于 Looking 状态，epoch =1，zxID =0，每个节点都推选自己，将投票信息广播出去
  - 根据规则，节点的 zx_ID 相同，推选 server_id 最大者为 leader，其他节点修改 vote_id 为最大节点ID，重新广播
  - 最大ID 节点当选 leader ，处于 Leading 状态，维持和其他节点的心跳，其他节点处于 Following 状态
- 特征
  - 算法性能高、广播消息，n 个节点组成的集群，同时广播，集群内通信量为 n * (n-1) 个消息，容易产生广播风暴
  - 除了选举节点，还增加了对比节点ID和数据ID，需要知道所有节点的ID和数据ID，选举时间相对较长
  - 选举稳定，当有新节点加入或节点故障恢复，会触发选主，但是不一定切主，除非节点数据数据ID和节点ID最大，并且获得投票过半，才会导致切主。

### 总结

|          | Bully                              | Raft                                        | ZAB                          |
| -------- | ---------------------------------- | ------------------------------------------- | ---------------------------- |
| 消息类型 | alive                              | 同意/不同意选举                             | <epoch,vote_id,vote_zxID>    |
| 选举机制 | 倾向ID更大节点（霸道）             | 收到过半投票                                | 倾向让数据最新/ID最大的节点  |
| 选举过程 | Leader 无响应/ID最大节点恢复故障时 | Candidate可以竞选，每个Follow只有一次投票权 | 可以多次投票，根据三元组选主 |
| 选举时间 | 短                                 | 较短                                        | 较长                         |
| 性能     | 低                                 | 高                                          | 较高                         |

---
title: "RTMP HLS 防盗链"
date: 2021-12-07T02:01:23+08:00
draft: true
toc: true
images:
tags: 
  - nginx
---

## nginx -rtmp-module 

- 支持 RTMP、HLS、MPEG-DASH 直播
- 支持 RTMP、HLS 点播
- 可以将一次直播分为多个视频文件存储
- 支持 H.264 视频编解码或 AAC 视频编解码
- 支持 FFmpeg 命令内嵌
- 支持回调 HTTP
- 可以使用 HTTP 对直播进行控制，删除/录播。
- 具有更优秀的缓存技术，确保在效率与解码之间达到平衡，获得更好的效果。
- 支持更多的操作系统

## Real Time Message Protocol 

实时消息传送协议，是 Adobe 公司为 Flash 播放器和服务器之间传输音/视频和数据而开发的私有协议。

RTMP 是一个开放的规范，可以通过 OpenAMF，SWF，FLV 和 F4V 格式，提供与 Adobe Flash Player 兼容 的视音频和数据。

### feats

- RTMP 是应用层协议，需要依靠底层可靠的传输层协议来保证信息传输的可靠性。

- 建立完基于传输层协议的链接后，需要客户端和服务端 <握手>来建立基于传输层之上的 RTMP 连接。

  连接会传输一些控制信息，eg SetChunkSize 、SetACKWindowSize

  CreateStream 命令会创建一个 Stream 链接，用于传输具体的音/视频等数据，以及控制信息传输的命令信息。

- RTMP 协议在传输时会对数据进行格式化，被格式化的消息被称为 RTMP Message。

- 为了更好的实现多路复用、分包和信息的公平性，发送端会把 Message 划分为带有 Message ID 的 Chunk 。每个 Chunk 可能是一个单独的 Message，也可能是 Message 的一部分，在接收端会根据 Chunk 中包含的 data 的长度、message id 和 message 的长度，把 chunk 还原成完整的 Message，从而实现信息的收发。

### handshake

RTMP 协议的 “握手” 由**三个固定大小**的 chunk 组成。

客户端和服务端个字发送三个相同的块，客户端发送的 [C0,C1,C2]，服务端发送的[S0,S1,S2]。

- 客户端要等收到 S1 之后才能发送 C2
- 客户端要等到 S2 之后才能发送其他信息 (控制信息和真实音/视频等数据）
- 服务端要等收到 C0 之后才能发送 S1
- 服务端必须要等收到 C1 之后才能发送 S2
- 服务端必须要等收到 C2 之后才能发送其他信息(控制信息和真实音/视频等数据)。



## HTTP Live Streaming

HLS 协议**基于HTTP**，最初是 Apple 公司针对 iPhone，iPod，iTouch 和 iPad 等移动设备开发的流，继承了很多 HTTP 的优点。

HTTP 允许用户使用普通的 Web 服务器（不是专门的流媒体服务器）轻松地将媒体内容部署到流中，HLS 流的行为类似于常规的 Web 流量。

**HLS 可以适应可变的网络条件，动态地调整回放，以匹配有线和无线连接的可用速度**。

- 可靠，易部署
- 关闭字幕
- 快速转发
- 反向播放
- 备用音/视频
- 插入广告
- 保护内容



典型的 HLS流中，支持 HLS 的视频编码器解决方案接受一个实时音频提要或分发的媒体文件。**编码器在不同的比特率、分辨率和质量级别上创建了多个版本(变体）的音/视频。**

编码器将这些变体分割成一系列的小文件，被称为**媒体段**。

编码器为每个变体创建一个媒体播放列表文件，其中包含指向改变体的媒体段的 URL 列表。还创建了一个主播放列表文件，其中包含对可变媒体播放列表的 URL 列表，以及控制流播放行为的描述性标记。

在生成播放列表和片段时，编码器或自动脚本将文件上载到 Web 服务器或 CDN 中。

通过在 Web 页面中嵌入主播放列表文件的链接，或者创建自己的自定义应用程序来下载主播放列表文件，用户可以提供对内容的访问。



### M3U8

编码器将媒体播放列表保存在 M3U 格式的文本文件(m3u8 文件)中，媒体播放列表中包含媒体段的 URL 和播放所需的其他信息。播放列表的三种类型：实时、事件或视频点播（VOD），决定了如何导航流。

### 实时播放

实时播放列表可以在有限的时间范围内快速地前进和反向播放，在结束之前，时间范围一直向前推进。

### 事件播放

可以回到流的开始。

### VOD

VOD 播放列表表示一个以前完成的程序，可以从头到尾完全导航。



当新创建的媒体段在服务器上可用时，实时和事件类型的程序都需要更新媒体播放列表。编码器将新媒体段引用并添加到播放列表的末尾，并将更新后的播放列表上传至服务器中。在 live 播放列表中，可以从媒体播放列表中删除对旧媒体段的引用，并将一个滑动窗口提供给连续流。



### tag

播放列表中的 **#EXT-X_PLAYLIST-TYPE:EVENT** 标签名称告诉媒体播放器，这个播放列表的行为将与一个实时媒体播放列表不同。

事件播放列表保留对旧媒体的引用，同时获得新的媒体引用。

在这个过程中会产生一个拓展的媒体播放列表。这种类型的播放列表允许观众从程序开始时自有地导航。

所有媒体片段的引用都保留在活动列表的播放列表中，所以，事件播放列表很容易转换为 VOD 播放列表。



VOD 播放列表包含了对所有可用媒体段的引用，这种播放列表允许观众浏览整个程序，#EXT-X-ENDLIST 标签标志着可下载媒体片段的结束。



### 主播放列表

主播放列表为流中的每个媒体播放列表提供一个地址，还包括了重要的细节数据（带宽、分辨率和编解码器），客户端通过这些信息可以决定最合适的变体和当前测量的可用的带宽。

主播放列表中，媒体播放列表的顺序无关紧要，除非启动了流，之后开始下载主播放列表可以播放的第一个版本，如果客户端条件允许，可以切换到另一个媒体播放列表中的流。

主播放列表只能下载一次，**媒体播放列表的下载次数和播放列表类型有关**，实时广播和事件广播，播放器在每个媒体段持续时间后下载媒体播放列表文件，因为播放器可能随着新的媒体段的更新或随着流的进度而丢失旧的媒体段，VOD 播放列表只能下载一次。

### 快速向前和向后

HLS 通过使用 I-frame 播放列表，支持快速的向前和向后回放，I-frame 播放列表指向已经存在的媒体段内的一个字节范围，快速向前和向后不需要特殊的媒体段。

### 交替音频和视频播放

HLS 主播放列表提供了多种音频渲染，可能包括多种语言音轨，HLS 还支持多个视频流（多个视频分屏）。

### 回退和流交替

主播放列表中，替代媒体播放列表可以根据带宽或设备的情况作为替代品，如果播放器不能重新加载媒体播放列表文件(404、服务器崩溃、CDN 节点问题)，会试图切换到另一个服务器上提供的兼容媒体播放列表。

HLS 提供具有相同带宽的多个媒体播放列表，播放器切换为相同的播放列表，提供一致的流性能。

### 定时的元数据

用户可以向媒体段添加各种元数据，这些数据在回放期间为应用程序提供了额外的信息，也就是弹幕。

给定的时间偏移量中插入额外的数据，被称为定时元数据(在给定的时间之后将定时元数据插入到所有片段中)。

### 广告插入

HLS 通过间断标记，可以将广告、播放列表中的标记平滑地在不通内容之间转换。

### 内容保护

媒体段可以使用采样级加密进行单独加密，在播放列表文件中显示了相应的关键文件，这样用户就可以获取解密的密钥？



## 防盗链控制权限

点播服务开启防盗链功能，CDN 会对所有播放请求中携带的关键信息进行校验，仅响应通过的请求，非法访问直接返回 403，防盗链方案中包含 Referer 防盗链和 Key 防盗链。

### Referer 防盗链

基于 HTTP 协议支持的 Referer 机制实现，通过请求中携带的 Referer 字段识别请求来源，配置黑白名单，点播服务将名单分发到 CDN中，CDN 将根据名单对请求进行过滤，达到最近本的访问控制的目的。

Referer 防盗链实现简单， 无需额外开发，快速生效，适用于音视频主要在 Web 端引用的场景。

但是由于 HTTP Header 的内容可伪造，Referer 防盗链只能达到最基本的保护，安全性不高。

### Key 防盗链

Key 防盗链式视频点播的加速节点与点播源站联合实现的，比 Referer 防盗链更为安全可靠。

1. 租户在点播服务控制面开启 key 防盗链功能，配置允许误差时间、算法等。
2. 点播服务将配置的密钥值等下发到 CDN 节点中
3. 租户通过点播服务获取到点播媒体的鉴权 URL
4. 播放器通过租户提供的鉴权播放URL 向CDN 请求视频播放
5. CDN 根据播放URL中携带的鉴权信息校验请求的合法性，仅校验通过的请求会被允许。

## HLS加密

防盗链机制可以控制播放行为，避免非授权用户通过播放 URL 下载或播放点播视频，单无法阻止恶意的付费用户将视频下载到本地进行二次分发。

现在的短视频或者视频网站，很多相同的视频，鬼畜，或者相似度很高的内容，个人更倾向于原创，或者翻拍。

### 加密流程

1. 视频尚上传到 VOD 服务后，请求 HLS加密
2. 点播服务收到加密请求后，向 KMS 请求加密密钥，将获取的密钥ID和密钥文件存储在点播服务中。
3. 点播服务向媒体处理服务请求 HLS 加密，媒体处理服务通过转码功能将对应的视频进行加密。**转码加密后生成的 m3u8 文件带有 #EXT-X-KEY 标签，**该标签包含了 "METHOD" 和 "URL" 属性，"URL" 为业务侧搭建的密钥管理服务地址。

### 解密流程

1. 用户登录播放器终端，业务侧会对终端用户进行身份校验，校验通过分配 Token，将带 Token 播放地址返回给播放器。
2. 播放器通过带 Token 的播放 URL 向 CDN 请求播放，ToKen 是动态的并且具有时效性，CDN 收到请求后，会直接回源到点播服务，点播服务会将请求 URL 中的 Token 写入请求的 m3u8 文件的 "URL" 中，点播服务返回给 CDN 的 m3u8 文件中会携带 Token。
3. 播放终端解析返回的 m3u8 文件，得到 EXT-X-KEY 标签中的 "URL" 内容，向 "URL" 请求密钥。
4. 业务侧的密钥管理服务收到请求后，先验证 Token，查询密钥。
5. 密钥管理服务将点播服务返回的密钥返回给播放终端，播放终端解密播放 m3u8 文件。



以上（权限控制）结合 华为云 VOD 服务，简单的介绍来自于 <直播系统开发基于Nginx与Nginx-rtmp-module>，看了一下，有了大概的了解，编解码器，各种格式的转换、压缩这些有机会再了解，有空搞一下，其实对 Web RTC 还是有一点兴趣的。









